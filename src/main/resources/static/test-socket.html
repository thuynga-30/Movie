<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Test Watch Together Socket</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.6.1/sockjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>
    <style>
        body { font-family: sans-serif; padding: 20px; }
        .box { border: 1px solid #ccc; padding: 10px; margin-bottom: 10px; }
        #messages { height: 300px; overflow-y: scroll; background: #f9f9f9; border: 1px solid #ddd; padding: 10px; }
    </style>
</head>
<body>

<h2>üé• Test Watch Together (WebSocket)</h2>

<div class="box">
    <label>1. Nh·∫≠p Room Code:</label>
    <input type="text" id="roomCode" placeholder="V√≠ d·ª•: A1B2C3" value="A1B2C3">
    <button onclick="connect()">K·∫øt n·ªëi v√†o Ph√≤ng</button>
    <span id="status" style="color: red; font-weight: bold;">Ch∆∞a k·∫øt n·ªëi</span>
</div>

<div class="box">
    <label>2. Chat:</label>
    <input type="text" id="chatInput" placeholder="Nh·∫≠p tin nh·∫Øn...">
    <button onclick="sendChat()">G·ª≠i Chat</button>
</div>

<div class="box">
    <label>3. Sync Video (Gi·∫£ l·∫≠p):</label>
    <button onclick="sendSync('PLAY', 10.5)">‚ñ∂ G·ª≠i L·ªánh PLAY (t·∫°i 10.5s)</button>
    <button onclick="sendSync('PAUSE', 20.0)">‚è∏ G·ª≠i L·ªánh PAUSE (t·∫°i 20s)</button>
    <button onclick="sendSync('SEEK', 50.0)">‚è© G·ª≠i L·ªánh SEEK (t·ªõi 50s)</button>
</div>

<h3>üì© Nh·∫≠t k√Ω nh·∫≠n tin (Real-time):</h3>
<div id="messages"></div>

<script>
    var stompClient = null;

    function connect() {
        var roomCode = document.getElementById('roomCode').value;
        if (!roomCode) { alert("Vui l√≤ng nh·∫≠p Room Code!"); return; }

        // 1. K·∫øt n·ªëi t·ªõi Endpoint /ws m√† ta ƒë√£ c·∫•u h√¨nh trong Spring Boot
        var socket = new SockJS('http://localhost:8080/ws');
        stompClient = Stomp.over(socket);

        stompClient.connect({}, function (frame) {
            document.getElementById('status').innerText = 'ƒê√£ k·∫øt n·ªëi: ' + roomCode;
            document.getElementById('status').style.color = 'green';
            console.log('Connected: ' + frame);

            // 2. ƒêƒÉng k√Ω nh·∫≠n tin t·ª´ Server (Subscribe)
            stompClient.subscribe('/topic/room/' + roomCode, function (payload) {
                showOutput(JSON.parse(payload.body));
            });
        }, function(error) {
            alert("L·ªói k·∫øt n·ªëi! H√£y ch·∫Øc ch·∫Øn Server ƒëang ch·∫°y.");
        });
    }

    function sendChat() {
        var roomCode = document.getElementById('roomCode').value;
        var content = document.getElementById('chatInput').value;

        // 3. G·ª≠i tin nh·∫Øn l√™n Server (Publish)
        stompClient.send("/app/chat/" + roomCode, {}, JSON.stringify({
            'type': 'CHAT',
            'message': content,
            'senderName': 'TestUser' // Gi·∫£ l·∫≠p t√™n ng∆∞·ªùi g·ª≠i
        }));
    }

    function sendSync(type, time) {
        var roomCode = document.getElementById('roomCode').value;

        // 4. G·ª≠i l·ªánh ƒë·ªìng b·ªô l√™n Server
        stompClient.send("/app/sync/" + roomCode, {}, JSON.stringify({
            'type': type,
            'seekTime': time
        }));
    }

    function showOutput(message) {
        var response = document.getElementById('messages');
        var p = document.createElement('p');
        p.style.wordWrap = 'break-word';

        if (message.type === 'CHAT') {
            p.innerHTML = `üí¨ <b>${message.senderName}:</b> ${message.message}`;
        } else {
            p.innerHTML = `‚öôÔ∏è <b>L·ªÜNH SYNC:</b> ${message.type} t·∫°i gi√¢y th·ª© ${message.seekTime}`;
            p.style.color = 'blue';
        }

        response.appendChild(p);
        response.scrollTop = response.scrollHeight;
    }
</script>


</body>
</html>